<script>
  const ADMIN_KEY = "PogiAngSoftwareDevNETO";
  const lockedScreen = document.getElementById("locked-screen");
  const adminApp = document.getElementById("admin-app");
  const adminHint = document.getElementById("admin-hint");

  function authorized() {
    return (window.location.hash || "") === "#key=" + ADMIN_KEY;
  }

  function isMobile() {
    return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  }

  if (isMobile()) {
    window.location.replace("index.html");
  } else {

    if (!authorized()) {
      lockedScreen.style.display = "flex";
      adminApp.style.display = "none";

      if (adminHint) adminHint.textContent = "Admin access link required.";
    } else {
      lockedScreen.style.display = "none";
      adminApp.style.display = "block";
    }
  }

  const toggleBtn = document.getElementById("theme-toggle");
  if (toggleBtn) {
    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      toggleBtn.textContent = document.body.classList.contains("dark-mode") ? "â˜€ï¸ Light Mode" : "ðŸŒ™ Dark Mode";
      localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
    });

    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark-mode");
      toggleBtn.textContent = "â˜€ï¸ Light Mode";
    }
  }

  (function () {
    const header = document.querySelector("#site-content header");
    if (!header) return;

    const setHeaderHeight = () => {
      document.documentElement.style.setProperty("--header-h", header.offsetHeight + "px");
    };

    const update = () => {
      const max = 260; 
      const y = Math.max(0, Math.min(max, window.scrollY || 0));
      const t = y / max;

      document.documentElement.style.setProperty("--shrink", t.toFixed(3));
      document.body.classList.toggle("progressive-shrink", t > 0.65);

      requestAnimationFrame(setHeaderHeight);
    };

    window.addEventListener("load", () => { setHeaderHeight(); update(); });
    window.addEventListener("resize", () => { setHeaderHeight(); update(); });
    window.addEventListener("scroll", update, { passive: true });
  })();

  const state = {
    online: true,
    maintenance: false,
    locked: false,
    inserts: 42,
    weightKg: 18.3,
    coins: 540,
    payoutsPHP: 120,
    binLevel: 65,
    currentWeight: 0.0,
    machineState: "Idle",
    door: "Closed",
    alerts: [],
    activity: ["System boot OK", "User redeemed â‚±20", "Insert detected: +10 coins"]
  };

  function setText(id, value){
    const el = document.getElementById(id);
    if(el) el.textContent = value;
  }

  function render() {
    const now = new Date();
    setText("last-updated", "Last updated: " + now.toLocaleString());

    const conn = document.getElementById("conn-pill");
    conn.textContent = state.online ? "ONLINE" : "OFFLINE";
    conn.className = "pill " + (state.online ? "online" : "offline");

    const mode = document.getElementById("mode-pill");
    mode.textContent = state.maintenance ? "MAINTENANCE MODE" : "NORMAL MODE";
    mode.className = "pill warn";

    setText("kpi-inserts", state.inserts);
    setText("kpi-weight", state.weightKg.toFixed(1) + " kg");
    setText("kpi-coins", state.coins);
    setText("kpi-payouts", "â‚±" + state.payoutsPHP);

    setText("bin-level", state.binLevel + "%");
    setText("bin-status", state.binLevel >= 90 ? "FULL" : state.binLevel >= 70 ? "Near Full" : "OK");
    setText("current-weight", state.currentWeight.toFixed(1) + " kg");
    setText("machine-state", state.locked ? "Locked" : state.machineState);
    setText("door-state", state.door);

    const alertsList = document.getElementById("alerts-list");
    alertsList.innerHTML = "";
    if (state.alerts.length === 0) {
      alertsList.innerHTML = "<li class='muted'>No alerts.</li>";
    } else {
      state.alerts.forEach(a => {
        const li = document.createElement("li");
        li.textContent = a;
        alertsList.appendChild(li);
      });
    }

    const activityList = document.getElementById("activity-list");
    activityList.innerHTML = "";
    if (state.activity.length === 0) {
      activityList.innerHTML = "<li class='muted'>No activity yet.</li>";
    } else {
      state.activity.slice(0, 6).forEach(a => {
        const li = document.createElement("li");
        li.textContent = a;
        activityList.appendChild(li);
      });
    }
  }

  render();

  document.getElementById("btn-maintenance")?.addEventListener("click", () => {
    state.maintenance = !state.maintenance;
    state.activity.unshift(state.maintenance ? "Maintenance mode enabled" : "Maintenance mode disabled");
    render();
  });

  document.getElementById("btn-reset")?.addEventListener("click", () => {
    state.activity.unshift("Machine reset triggered");
    state.currentWeight = 0.0;
    state.machineState = "Idle";
    render();
  });

  document.getElementById("btn-clear-alerts")?.addEventListener("click", () => {
    state.alerts = [];
    state.activity.unshift("Alerts cleared");
    render();
  });

  document.getElementById("btn-lock")?.addEventListener("click", () => {
    state.locked = !state.locked;
    state.activity.unshift(state.locked ? "Machine locked" : "Machine unlocked");
    render();
  });
</script>
